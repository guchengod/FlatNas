import{d as G,M as ae,N as Te,r as v,w as O,y as be,a as m,e as f,_ as we,F as se,h as Ce,t as R,u as Ee,c as Se,o as Pe,b as C,g as y,E as re,k as ie,i as p,q as le,p as Ae,A as ce,l as Ve,m as ze,O as de,j as He}from"./index-DXce9nG8.js";const je=["contenteditable","data-placeholder"],Fe=G({__name:"MemoEditor",props:ae({editable:{type:Boolean},placeholder:{}},{content:{},contentModifiers:{}}),emits:ae(["focus","blur","input"],["update:content"]),setup(t,{expose:e,emit:n}){const a=n,s=Te(t,"content"),r=v(null),d=v(!1);O(s,b=>{!d.value&&r.value&&b!==r.value.innerHTML&&(r.value.innerHTML=b||"")});const l=()=>{r.value&&(s.value=r.value.innerHTML),a("input")},i=()=>{d.value=!0,a("focus")},u=()=>{d.value=!1,l(),a("blur")},x=(b,k)=>{document.execCommand(b,!1,k),l(),r.value&&r.value.focus()};return be(()=>{r.value&&(r.value.innerHTML=s.value||"")}),e({execCommand:x,editorRef:r}),(b,k)=>(f(),m("div",{ref_key:"editorRef",ref:r,contenteditable:t.editable,class:"w-full h-full bg-transparent outline-none text-sm text-gray-800 break-words font-sans leading-relaxed overflow-y-auto p-2 empty:before:content-[attr(data-placeholder)] empty:before:text-gray-400","data-placeholder":t.placeholder,onInput:l,onFocus:i,onBlur:u},null,40,je))}}),Ne=we(Fe,[["__scopeId","data-v-3d2ca38b"]]),Oe={class:"flex items-center gap-1 mt-2 pt-2 border-t border-gray-200/20 flex-wrap"},Re={key:0,class:"w-px h-4 bg-gray-400/30 mx-1"},$e=["aria-label","title","onClick"],We=["innerHTML"],Ue={key:1,class:"text-[10px] font-bold w-4 h-4 flex items-center justify-center"},Ke=G({__name:"MemoToolbar",emits:["command"],setup(t,{emit:e}){const n=e,a=[{cmd:"bold",label:"Bold",icon:'<path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4h-1v4h1a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6V4zm5 6h3a2 2 0 0 0 0-4h-3v4zm0 8h3a2 2 0 0 0 0-4h-3v4z"/>'},{cmd:"italic",label:"Italic",icon:'<path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/>'},{separator:!0},{cmd:"formatBlock",val:"H1",label:"H1",text:"H1"},{cmd:"formatBlock",val:"H2",label:"H2",text:"H2"},{separator:!0},{cmd:"insertUnorderedList",label:"List",icon:'<path d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.67-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z"/>'},{cmd:"formatBlock",val:"PRE",label:"Code",icon:'<path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>'},{cmd:"formatBlock",val:"BLOCKQUOTE",label:"Quote",icon:'<path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/>'}],s=r=>{r.cmd&&n("command",r.cmd,r.val)};return(r,d)=>(f(),m("div",Oe,[(f(),m(se,null,Ce(a,(l,i)=>(f(),m(se,{key:i},[l.separator?(f(),m("div",Re)):(f(),m("button",{key:1,type:"button",class:"p-1.5 rounded transition-all duration-200 text-gray-600 hover:text-[#0052D9] hover:bg-white/40 focus:outline-none focus:ring-2 focus:ring-[#0052D9]/50 disabled:opacity-40 disabled:cursor-not-allowed active:scale-95","aria-label":l.label,title:l.label,onClick:u=>s(l)},[l.icon?(f(),m("svg",{key:0,viewBox:"0 0 24 24",class:"w-4 h-4 fill-current",innerHTML:l.icon},null,8,We)):(f(),m("span",Ue,R(l.text),1))],8,$e))],64))),64))]))}}),$=(t,e)=>e.some(n=>t instanceof n);let ue,fe;function Qe(){return ue||(ue=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ge(){return fe||(fe=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const W=new WeakMap,H=new WeakMap,E=new WeakMap;function Je(t){const e=new Promise((n,a)=>{const s=()=>{t.removeEventListener("success",r),t.removeEventListener("error",d)},r=()=>{n(I(t.result)),s()},d=()=>{a(t.error),s()};t.addEventListener("success",r),t.addEventListener("error",d)});return E.set(e,t),e}function Xe(t){if(W.has(t))return;const e=new Promise((n,a)=>{const s=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",d),t.removeEventListener("abort",d)},r=()=>{n(),s()},d=()=>{a(t.error||new DOMException("AbortError","AbortError")),s()};t.addEventListener("complete",r),t.addEventListener("error",d),t.addEventListener("abort",d)});W.set(t,e)}let U={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return W.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return I(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function xe(t){U=t(U)}function Ye(t){return Ge().includes(t)?function(...e){return t.apply(K(this),e),I(this.request)}:function(...e){return I(t.apply(K(this),e))}}function Ze(t){return typeof t=="function"?Ye(t):(t instanceof IDBTransaction&&Xe(t),$(t,Qe())?new Proxy(t,U):t)}function I(t){if(t instanceof IDBRequest)return Je(t);if(H.has(t))return H.get(t);const e=Ze(t);return e!==t&&(H.set(t,e),E.set(e,t)),e}const K=t=>E.get(t);function qe(t,e,{blocked:n,upgrade:a,blocking:s,terminated:r}={}){const d=indexedDB.open(t,e),l=I(d);return a&&d.addEventListener("upgradeneeded",i=>{a(I(d.result),i.oldVersion,i.newVersion,I(d.transaction),i)}),n&&d.addEventListener("blocked",i=>n(i.oldVersion,i.newVersion,i)),l.then(i=>{r&&i.addEventListener("close",()=>r()),s&&i.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),l}const et=["get","getKey","getAll","getAllKeys","count"],tt=["put","add","delete","clear"],j=new Map;function me(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(j.get(e))return j.get(e);const n=e.replace(/FromIndex$/,""),a=e!==n,s=tt.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!(s||et.includes(n)))return;const r=async function(d,...l){const i=this.transaction(d,s?"readwrite":"readonly");let u=i.store;return a&&(u=u.index(l.shift())),(await Promise.all([u[n](...l),s&&i.done]))[0]};return j.set(e,r),r}xe(t=>({...t,get:(e,n,a)=>me(e,n)||t.get(e,n,a),has:(e,n)=>!!me(e,n)||t.has(e,n)}));const nt=["continue","continuePrimaryKey","advance"],ve={},Q=new WeakMap,ke=new WeakMap,ot={get(t,e){if(!nt.includes(e))return t[e];let n=ve[e];return n||(n=ve[e]=function(...a){Q.set(this,ke.get(this)[e](...a))}),n}};async function*at(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,ot);for(ke.set(n,e),E.set(n,K(e));e;)yield n,e=await(Q.get(n)||e.continue()),Q.delete(n)}function he(t,e){return e===Symbol.asyncIterator&&$(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&$(t,[IDBIndex,IDBObjectStore])}xe(t=>({...t,get(e,n,a){return he(e,n)?at:t.get(e,n,a)},has(e,n){return he(e,n)||t.has(e,n)}}));const st="flatnas-memo-db",_="memos",rt=1;function pe(t){let e=5381;for(let n=0;n<t.length;n++)e=e*33^t.charCodeAt(n);return(e>>>0).toString(16)}const F=(t,e)=>{console.error(`[Sentry Report] ${e}:`,t);const n=window.Sentry;n&&n.captureException(t,{tags:{context:e}})};let N=null;function ge(){return N||(N=qe(st,rt,{upgrade(t){t.objectStoreNames.contains(_)||t.createObjectStore(_,{keyPath:"id"})}})),N}function it(t,e,n){const a=v("idle"),s=v(0),r=async(l=0)=>{a.value="saving",s.value=30;try{const i=await ge(),u=e.value,x=pe(u),b={id:t,content:u,mode:n.value,updatedAt:Date.now(),checksum:x};s.value=60,await i.put(_,b);const k=await i.get(_,t);if(!k||k.checksum!==x)throw new Error("Checksum validation failed");s.value=100,a.value="success",setTimeout(()=>{a.value="idle",s.value=0},1200)}catch(i){console.error(`Save failed (attempt ${l+1})`,i),l<3?setTimeout(()=>r(l+1),500*(l+1)):(a.value="error",F(i,"MemoPersistenceSave"))}};return{saveToIndexedDB:r,loadFromIndexedDB:async()=>{try{const i=await(await ge()).get(_,t);i&&(pe(i.content)===i.checksum?(e.value=i.content,n.value=i.mode):F(new Error("Data corruption detected on load"),"MemoPersistenceLoad"))}catch(l){F(l,"MemoPersistenceLoad")}},status:a,progress:s}}const lt={class:"flex items-center justify-between mb-2 z-10"},ct=["disabled"],dt={key:0,class:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},ut={key:1,class:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},ft={class:"flex-1 min-h-0 relative"},mt=["placeholder","readonly"],vt={key:0,class:"absolute top-12 right-4 z-30 bg-gray-800 text-white text-xs px-3 py-1.5 rounded shadow-lg flex items-center gap-2"},ht=800,ye=800,pt=5e3,gt=G({__name:"MemoWidget",props:{widget:{}},setup(t){const e=t,n=Ee(),a=v("simple"),s=v(""),r=v(null),d=v(!1),l=v(0),i=v(0),u=v(!1),x=v(document.visibilityState==="visible"),{saveToIndexedDB:b,loadFromIndexedDB:k,status:M,progress:S}=it(e.widget.id,s,a),P=v(!1),J=v(""),Ie=Se(()=>({backgroundColor:`rgba(254, 249, 195, ${e.widget.opacity??.9})`,color:e.widget.textColor||"#374151"})),Me=(c,o)=>{r.value?.execCommand(c,o)},Be=async()=>{await b(),M.value==="success"&&(J.value="已保存，刷新不丢失",P.value=!0,setTimeout(()=>P.value=!1,3e3)),V(!0)},De=()=>{a.value=a.value==="simple"?"rich":"simple";const c=A();l.value=c.updatedAt,V(!0),n.isLogged&&n.socket?.emit("memo:update",{token:n.token||localStorage.getItem("flat-nas-token"),widgetId:e.widget.id,content:c})},Le=c=>{let o="",h=a.value,oe=0;if(typeof c=="string")o=c;else if(c&&typeof c=="object"){const g=c;typeof g.content=="string"?o=g.content:typeof g.rich=="string"?o=g.rich:typeof g.simple=="string"&&(o=g.simple),(g.mode==="simple"||g.mode==="rich")&&(h=g.mode),typeof g.updatedAt=="number"&&(oe=g.updatedAt)}return{content:o,mode:h,updatedAt:oe}},A=()=>({content:s.value,mode:a.value,updatedAt:Date.now()});let B=null,L=null;const V=(c=!1)=>{if(!n.isLogged)return;const o=()=>{const h=A();l.value=h.updatedAt,n.saveWidget(e.widget.id,h)};if(c){o();return}B&&clearTimeout(B),B=setTimeout(()=>{B=null,o()},800)},X=c=>{const o=Le(c);o.content&&(d.value||o.updatedAt&&o.updatedAt<=l.value||o.content!==s.value&&(s.value=o.content,a.value=o.mode,l.value=o.updatedAt||Date.now()))},_e=()=>{!u.value||!n.isLogged||(L&&clearTimeout(L),L=setTimeout(()=>{if(!u.value||!n.isLogged)return;const c=A();n.socket?.emit("memo:update",{token:n.token||localStorage.getItem("flat-nas-token"),widgetId:e.widget.id,content:c})},300))},D=()=>{const c=d.value&&Date.now()-i.value<=ht,o=x.value?ye:pt;c?(w&&(clearInterval(w),w=null),u.value=!0):(u.value=!1,w?w&&o!==Z&&(clearInterval(w),w=setInterval(ee,o)):w=setInterval(ee,o)),Z=o},Y=()=>{i.value=Date.now(),D(),_e()};k().then(()=>{if(!s.value&&e.widget.data){if(typeof e.widget.data=="string")s.value=e.widget.data;else{const c=e.widget.data;s.value=c.rich||c.simple||"",a.value=c.mode||"simple"}l.value=Date.now()}});let T;O([s,a],()=>{clearTimeout(T),T=setTimeout(()=>{b(),V()},800)}),O(()=>e.widget.data,c=>{c&&X(c)});let w=null,z=null,Z=ye;const q=()=>{x.value=document.visibilityState==="visible",D()},ee=async()=>{if(!n.isLogged||!n.isConnected||d.value)return;const c=e.widget.id;if(c)try{const o=await fetch(`/api/widgets/${c}`,{headers:n.getHeaders()});if(!o.ok)return;const h=await o.json();h?.data&&X(h.data)}catch{return}};be(()=>{D(),z=setInterval(D,1e3),document.addEventListener("visibilitychange",q)}),Pe(()=>{w&&clearInterval(w),z&&clearInterval(z),B&&clearTimeout(B),T&&clearTimeout(T),L&&clearTimeout(L),document.removeEventListener("visibilitychange",q)});const te=()=>{d.value=!0,D()},ne=()=>{d.value=!1,D()};return(c,o)=>(f(),m("div",{class:"w-full h-full p-4 rounded-2xl backdrop-blur border border-white/10 relative group flex flex-col transition-colors duration-300 overflow-hidden",style:le(Ie.value)},[p(S)>0?(f(),m("div",{key:0,class:"absolute top-0 left-0 h-1 bg-[#0052D9] transition-all duration-300 rounded-t-2xl z-20",style:le({width:`${p(S)}%`,opacity:p(S)===100?0:1})},null,4)):C("",!0),y("div",{class:"absolute top-0 left-0 w-3 h-3 cursor-pointer z-50 overflow-hidden group/curl",onClick:De,title:"切换模式 (Switch Mode)"},[...o[2]||(o[2]=[y("div",{class:"absolute top-0 left-0 w-0 h-0 border-t-[12px] border-r-[12px] border-t-white/0 border-r-black/20 transform translate-x-0.5 translate-y-0.5 blur-[1px] transition-all duration-300 group-hover/curl:scale-105"},null,-1),y("div",{class:"absolute top-0 left-0 w-0 h-0 border-t-[12px] border-r-[12px] border-t-white/90 border-r-transparent shadow-sm transition-all duration-300 group-hover/curl:border-t-white group-hover/curl:scale-105"},null,-1)])]),y("div",lt,[o[5]||(o[5]=y("div",{class:"flex gap-1"},null,-1)),a.value==="rich"?(f(),m("button",{key:0,onClick:Be,class:Ae(["flex items-center gap-1 px-3 py-1 rounded-md text-xs font-medium text-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#0052D9]",[p(M)==="success"?"bg-green-500 animate-pulse":"bg-[#0052D9] hover:brightness-110",p(M)==="saving"?"opacity-70 cursor-wait":""]]),disabled:p(M)==="saving",title:"保存 (Save)"},[p(M)==="success"?(f(),m("svg",dt,[...o[3]||(o[3]=[y("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"},null,-1)])])):(f(),m("svg",ut,[...o[4]||(o[4]=[y("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"},null,-1)])])),y("span",null,R(p(M)==="success"?"已保存":"保存"),1)],10,ct)):C("",!0)]),y("div",ft,[ie(de,{name:"page-tear",mode:"out-in"},{default:ce(()=>[(f(),m("div",{key:a.value,class:"w-full h-full"},[a.value==="simple"?Ve((f(),m("textarea",{key:0,"onUpdate:modelValue":o[0]||(o[0]=h=>s.value=h),class:"w-full h-full bg-transparent resize-none outline-none text-sm placeholder-gray-600 font-medium p-2",placeholder:p(n).isLogged?"写点什么...":"请先登录",readonly:!p(n).isLogged,onFocus:te,onBlur:ne,onInput:Y},null,40,mt)),[[ze,s.value]]):(f(),re(Ne,{key:1,ref_key:"editorRef",ref:r,content:s.value,"onUpdate:content":o[1]||(o[1]=h=>s.value=h),editable:p(n).isLogged,placeholder:p(n).isLogged?"在此输入内容...":"请先登录",onFocus:te,onBlur:ne,onInput:Y},null,8,["content","editable","placeholder"]))]))]),_:1})]),a.value==="rich"?(f(),re(Ke,{key:1,onCommand:Me})):C("",!0),ie(de,{"enter-active-class":"transition ease-out duration-300","enter-from-class":"transform opacity-0 translate-y-2","enter-to-class":"transform opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-200","leave-from-class":"transform opacity-100 translate-y-0","leave-to-class":"transform opacity-0 translate-y-2"},{default:ce(()=>[P.value?(f(),m("div",vt,[o[6]||(o[6]=y("svg",{class:"w-3 h-3 text-green-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[y("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),He(" "+R(J.value),1)])):C("",!0)]),_:1})],4))}}),bt=we(gt,[["__scopeId","data-v-b8a071b6"]]);export{bt as default};
