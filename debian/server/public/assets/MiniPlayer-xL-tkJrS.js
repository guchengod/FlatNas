import{d as U,u as H,r as o,I as W,w,D as g,E as D,o as $,e as x,b as M,h as l,C as G,t as R,_ as X}from"./index-0Xhfa8Kb.js";const F={class:"h-10 w-10 xl:w-[160px] px-0 rounded-full bg-transparent flex items-center gap-2 transition-all group select-none relative left-0 xl:-left-[5px]"},J=["src"],K={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-6 h-6"},N={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-6 h-6 pl-0.5"},O=["title"],Q={class:"flex items-center w-full pr-0"},Y={class:"text-[12px] opacity-70 origin-left truncate w-auto mr-auto"},Z={class:"flex items-center gap-0.5 flex-shrink-0 origin-right"},ee=["disabled"],te=U({__name:"MiniPlayer",setup(ae){const r=H(),n=o(!1),u=o(null),A=W("flat-nas-music-volume",.7),v=o([]),s=o("加载中..."),_=o(null),b=o(null),f=o(!1),k=o("3s"),P=o("0px");w(()=>r.activeMusicPlayer,e=>{e!=="mini-player"&&n.value&&(u.value&&u.value.pause(),n.value=!1)});const d=o([]),i=o(-1),B=e=>{if(!e||e==="加载中..."||e==="无音乐")return;const t=`/music/${e.split("/").map(a=>encodeURIComponent(a).replace(/'/g,"%27")).join("/")}`;return r.getAssetUrl(t)},I=async()=>{try{const t=await(await fetch("/api/music-list")).json();if(t.length>0){v.value=t;const a=t[Math.floor(Math.random()*t.length)];s.value=a,d.value=[a],i.value=0,r.appConfig.autoPlayMusic&&setTimeout(()=>{m()},1e3)}else s.value="无音乐"}catch{s.value="获取失败"}};let c=0,h=null;const C=e=>{h&&clearTimeout(h),h=setTimeout(()=>{e()},120)},E=()=>{v.value.length<=1||C(async()=>{if(i.value<d.value.length-1)i.value++,s.value=d.value[i.value]||"";else{let e=s.value;for(;e===s.value;)e=v.value[Math.floor(Math.random()*v.value.length)]||"";s.value=e,d.value.push(e),i.value++}await g(),m()})},V=()=>{i.value>0&&C(async()=>{i.value--,s.value=d.value[i.value]||"",await g(),m()})},m=async()=>{const e=u.value;if(!e)return;const t=++c;try{e.pause(),e.load();const a=e.play();if(a!==void 0&&await a,t!==c)return;n.value=!0,r.activeMusicPlayer="mini-player"}catch(a){if(t!==c)return;const p=a?.message||"";if(p.includes("interrupted by a new load request")||p.includes("play() request was interrupted"))return;console.error("[MiniPlayer] Play failed:",a),n.value=!1}},j=e=>{const t=e.target;console.error("[MiniPlayer] Audio error:",t.error,t.src),n.value=!1},z=async()=>{const e=u.value;if(e)if(n.value)e.pause(),n.value=!1,c++;else try{e.error&&e.load();const t=++c,a=e.play();if(a!==void 0&&await a,t!==c)return;n.value=!0,r.activeMusicPlayer="mini-player"}catch(t){const a=t?.message||"";if(a.includes("interrupted by a new load request")||a.includes("play() request was interrupted"))return;console.error("[MiniPlayer] Toggle play failed:",t),e.load()}},q=()=>{const e=_.value,t=b.value;if(!e||!t){f.value=!1;return}const a=t.scrollWidth-e.clientWidth;if(a>0&&n.value){f.value=!0;const p=Math.max(a/50,2);k.value=p+"s",P.value="-"+a+"px"}else f.value=!1};w([s,n],async()=>{await g(),q()}),w(A,e=>{u.value&&(u.value.volume=Math.max(0,Math.min(1,e)))},{immediate:!0});let y,L=!1;const T=async()=>{if(!r.appConfig.autoPlayMusic)return;const e=u.value;if(e)try{e.load(),await e.play(),n.value=!0}catch{S()}},S=()=>{if(L)return;L=!0;const e=async()=>{await T(),t()},t=()=>{window.removeEventListener("pointerdown",e),window.removeEventListener("touchstart",e),window.removeEventListener("keydown",e),document.removeEventListener("click",e)};window.addEventListener("pointerdown",e,{once:!0}),window.addEventListener("touchstart",e,{once:!0}),window.addEventListener("keydown",e,{once:!0}),document.addEventListener("click",e,{once:!0})};return D(()=>{console.log("[MiniPlayer] Mounted"),y=setTimeout(()=>{I(),setTimeout(q,200)},500),r.appConfig.autoPlayMusic&&S()}),$(()=>{console.log("[MiniPlayer] Unmounted"),y&&clearTimeout(y)}),w(()=>r.appConfig.autoPlayMusic,async e=>{e&&await T()},{immediate:!1}),(e,t)=>(M(),x("div",F,[l("audio",{ref_key:"audioRef",ref:u,preload:"none",src:B(s.value),onEnded:E,onError:j},null,40,J),l("button",{onClick:z,class:"w-10 h-10 flex-shrink-0 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/40 hover:text-white transition-all active:scale-95 text-white backdrop-blur border border-white/20 shadow-sm"},[n.value?(M(),x("svg",K,[...t[0]||(t[0]=[l("path",{"fill-rule":"evenodd",d:"M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0115 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H15a.75.75 0 01-.75-.75V5.25z","clip-rule":"evenodd"},null,-1)])])):(M(),x("svg",N,[...t[1]||(t[1]=[l("path",{"fill-rule":"evenodd",d:"M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z","clip-rule":"evenodd"},null,-1)])]))]),l("div",{ref_key:"titleWrapRef",ref:_,class:"flex-1 overflow-hidden text-xs font-medium text-white text-shadow hidden xl:flex flex-col justify-center min-w-0 h-full py-0.5",title:s.value},[l("span",{ref_key:"titleTextRef",ref:b,class:"",style:G(f.value?{"--marquee-to":P.value,animation:`marqueeX ${k.value} linear infinite alternate`,display:"inline-block",whiteSpace:"nowrap"}:{whiteSpace:"nowrap"})},R(s.value.replace(/\.(mp3|flac|wav|m4a)$/i,"")),5),l("div",Q,[l("span",Y,R(n.value?"正在播放":"已暂停"),1),l("div",Z,[l("button",{onClick:V,class:"w-6 h-6 rounded-full flex items-center justify-center text-white/80 hover:text-white hover:bg-white/20 transition-all disabled:opacity-30 disabled:hover:bg-transparent disabled:cursor-not-allowed",title:"上一首",disabled:i.value<=0},[...t[2]||(t[2]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-4 h-4"},[l("path",{d:"M9.195 18.44c1.25.713 2.805-.19 2.805-1.629v-2.81l7.82 4.466c1.25.713 2.805-.19 2.805-1.629V7.162c0-1.44-1.555-2.342-2.805-1.628l-7.82 4.466v-2.81c0-1.44-1.555-2.343-2.805-1.629l-7.108 4.062c-1.26.72-1.26 2.536 0 3.256l7.108 4.061z"})],-1)])],8,ee),l("button",{onClick:E,class:"w-6 h-6 rounded-full flex items-center justify-center text-white/80 hover:text-white hover:bg-white/20 transition-all",title:"下一首"},[...t[3]||(t[3]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-4 h-4"},[l("path",{d:"M5.055 7.06C3.805 6.347 2.25 7.25 2.25 8.69v8.122c0 1.44 1.555 2.342 2.805 1.628L12.875 14v2.81c0 1.44 1.555 2.343 2.805 1.629l7.108-4.061c1.26-.72 1.26-2.536 0-3.256l-7.108-4.062c-1.25-.713-2.805.19-2.805 1.629V11.5L5.055 7.06z"})],-1)])])])])],8,O)]))}}),ne=X(te,[["__scopeId","data-v-eb994dd1"]]);export{ne as default};
